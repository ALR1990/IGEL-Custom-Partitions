<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<profiles>
    <profile>
        <profile_id>206991</profile_id>
        <profilename>Wireguard</profilename>
        <firmware>
            <model>IGEL OS 11</model>
            <version>11.07.100.01</version>
        </firmware>
        <description>Wireguard</description>
        <overwritesessions>false</overwritesessions>
        <is_master_profile>false</is_master_profile>
        <is_igel_os>true</is_igel_os>
        <settings>
            <pclass name="system.environment_variables.fixvariable%.name">
                <pvalue instancenr="0" variableExpression="" variableSubstitutionActive="false">WG_PUBLIC_ADDRESS</pvalue>
                <pvalue instancenr="1" variableExpression="" variableSubstitutionActive="false">WG_PUBLIC_IPV4</pvalue>
                <pvalue instancenr="2" variableExpression="" variableSubstitutionActive="false">WG_PUBLIC_IPV6</pvalue>
                <pvalue instancenr="3" variableExpression="" variableSubstitutionActive="false">WG_PORT</pvalue>
                <pvalue instancenr="4" variableExpression="" variableSubstitutionActive="false">WG_DNS1</pvalue>
                <pvalue instancenr="5" variableExpression="" variableSubstitutionActive="false">WG_DNS2</pvalue>
                <pvalue instancenr="6" variableExpression="" variableSubstitutionActive="false">WG_PUBLIC_KEY</pvalue>
                <pvalue instancenr="7" variableExpression="" variableSubstitutionActive="false">WG_PRESHARE_KEY</pvalue>
                <variableSubstitutionActive>false</variableSubstitutionActive>
            </pclass>
            <pclass name="system.environment_variables.fixvariable%.value">
                <pvalue instancenr="0" variableExpression="" variableSubstitutionActive="false">192.168.205.9</pvalue>
                <pvalue instancenr="1" variableExpression="" variableSubstitutionActive="false">10.66.66.2/32</pvalue>
                <pvalue instancenr="2" variableExpression="" variableSubstitutionActive="false">fd42:42:42::2/128</pvalue>
                <pvalue instancenr="3" variableExpression="" variableSubstitutionActive="false">51820</pvalue>
                <pvalue instancenr="4" variableExpression="" variableSubstitutionActive="false">8.8.8.8</pvalue>
                <pvalue instancenr="5" variableExpression="" variableSubstitutionActive="false">8.8.4.4</pvalue>
                <pvalue instancenr="6" variableExpression="" variableSubstitutionActive="false">ABC=</pvalue>
                <pvalue instancenr="7" variableExpression="" variableSubstitutionActive="false">DEF=</pvalue>
                <variableSubstitutionActive>false</variableSubstitutionActive>
            </pclass>
            <pclass name="userinterface.rccustom.custom_cmd_net_final">
                <pvalue instancenr="-1" variableExpression="" variableSubstitutionActive="false">mkdir -p /wfs/wireguard; chmod 700 /wfs/wireguard; cat &amp;lt&amp;lt 'EOF' &amp;gt /wfs/wireguard/igel_wg_setup.sh
#!/bin/bash
#set -x
#trap read debug

ACTION="wireguard_setup_${1}"

# output to systemlog with ID amd tag
LOGGER="logger -it ${ACTION}"

echo "Starting" | $LOGGER

WFS_WG=/wfs/wireguard
ETC_WG=/etc/wireguard

if &amp;lb ! -e ${WFS_WG}/privatekey &amp;rb; then
  wg genkey | tee ${WFS_WG}/privatekey | wg pubkey | tee ${WFS_WG}/publickey
  WG_PUBKEY=$(cat ${WFS_WG}/publickey)
  setparam system.remotemanager.ums_structure_tag ${WG_PUBKEY}
  write_rmsettings
fi

cp ${WFS_WG}/privatekey ${ETC_WG}/privatekey
cp ${WFS_WG}/publickey ${ETC_WG}/publickey
cp ${WFS_WG}/wg0.conf ${ETC_WG}/wg0.conf

HOSTNAME=$(hostname)
HOST_PRIVATEKEY=$(cat ${ETC_WG}/privatekey)

sed -i "s|CLIENT_PRIVATE_KEY|${HOST_PRIVATEKEY}|" ${ETC_WG}/wg0.conf
sed -i "s|WG_DNS1|${WG_DNS1}|" ${ETC_WG}/wg0.conf
sed -i "s|WG_DNS2|${WG_DNS2}|" ${ETC_WG}/wg0.conf
sed -i "s|WG_PUBLIC_KEY|${WG_PUBLIC_KEY}|" ${ETC_WG}/wg0.conf
sed -i "s|WG_PRESHARE_KEY|${WG_PRESHARE_KEY}|" ${ETC_WG}/wg0.conf
sed -i "s|WG_PUBLIC_ADDRESS|${WG_PUBLIC_ADDRESS}|" ${ETC_WG}/wg0.conf
sed -i "s|WG_PORT|${WG_PORT}|" ${ETC_WG}/wg0.conf

cat ${WFS_WG}/wg_clients.csv| while read LINE
  do
    CURR_HOST=$(echo ${LINE} | awk --field-separator "," '{print $1}')
    if &amp;lb ${HOSTNAME} = ${CURR_HOST} &amp;rb; then
      CURR_HOST_ADDR=$(echo ${LINE} | awk --field-separator "," '{print $2}')
      sed -i "s|CURR_HOST_ADDR|${CURR_HOST_ADDR}|" ${ETC_WG}/wg0.conf
    fi
  done

chmod 400 /etc/wireguard/*
chmod 400 /wfs/wireguard/*
chmod 500 /wfs/wireguard/igel_wg_setup.sh
wg-quick up wg0 | $LOGGER
EOF

cat &amp;lt&amp;lt 'EOF' &amp;gt /wfs/wireguard/wg_clients.csv
ITC6845F1391E31,10.66.66.4/32
ITC0800270F8F75,10.66.66.5/32
ITC000C29A1EAF6,10.66.66.6/32
ITC000C29E8B942,10.66.66.7/32
EOF

cat &amp;lt&amp;lt 'EOF' &amp;gt /wfs/wireguard/wg0.conf
[Interface]
PrivateKey = CLIENT_PRIVATE_KEY
Address = CURR_HOST_ADDR
DNS = WG_DNS1,WG_DNS2

[Peer]
PublicKey = WG_PUBLIC_KEY
PresharedKey = WG_PRESHARE_KEY
Endpoint = WG_PUBLIC_ADDRESS:WG_PORT
AllowedIPs = 0.0.0.0/0,::/0
EOF

chmod 400 /wfs/wireguard/*
chmod 500 /wfs/wireguard/igel_wg_setup.sh
/wfs/wireguard/igel_wg_setup.sh
</pvalue>
                <variableSubstitutionActive>false</variableSubstitutionActive>
            </pclass>
        </settings>
        <instancesettings/>
    </profile>
</profiles>
